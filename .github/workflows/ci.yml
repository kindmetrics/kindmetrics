name: Kindmetrics CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: "*"

jobs:
  check_format:
    runs-on: ubuntu-latest
    container:
      image: crystallang/crystal:0.35.1
    steps:
      - uses: actions/checkout@v1
      - name: Install shards
        run: shards install
      - name: Format
        run: crystal tool format --check
  specs:
    runs-on: ubuntu-latest
    container:
      image: crystallang/crystal:0.35.1
    services:
      # Label used to access the service container
      postgres:
        # Docker Hub image
        image: postgres
        # Provide the password for postgres
        env:
          POSTGRES_PASSWORD: postgres
        # Set health checks to wait until postgres has started
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      clickhouse:
        # Docker Hub image
        image: yandex/clickhouse-server
    steps:
    - uses: actions/checkout@v2
    - name: Add postgres key
      run: apt-get update && apt-get install -y wget ca-certificates lsb-release && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -
    - name: Add postgres to apt-get
      run: echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list
    - name: Install postgres
      run: apt-get update && apt-get install -y postgresql-contrib libpq-dev
    - name: Install shards
      run: shards install
    - name: Cache Crystal
      uses: actions/cache@v1
      with:
        path: ~/.cache/crystal
        key: ${{ runner.os }}-crystal
    - name: migrate clickhouse
      run: crystal run ./tasks.cr -- kind.clickhouse
      env:
          # The hostname used to communicate with the PostgreSQL service container
          DB_HOST: postgres
          CLICKHOUSE_HOST: clickhouse
          EMAIL_FROM: test@test.com
          EMAIL_FROM_NAME: Kindmetrics
    - name: Run tests
      run: crystal spec
      env:
          # The hostname used to communicate with the PostgreSQL service container
          DB_HOST: postgres
          CLICKHOUSE_HOST: clickhouse
          EMAIL_FROM: test@test.com
          EMAIL_FROM_NAME: Kindmetrics
